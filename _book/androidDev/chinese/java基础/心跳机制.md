# 心跳机制
心跳包机制、延迟发送任务
```java
public abstract class HeartBeatTask implements Runnable {
	private String taskName  ;
	public HeartBeatTask( ){
		taskName = "beatTask_"+System.nanoTime() ;
	}

	public String getTaskName() {
		return taskName;
	}
}
```

<br>

```java
/**
 * 优点除了线程池的特性以外，可以实现循环或延迟任务
 */
 public class WkHeartBeatTool {
    private ScheduledExecutorService mScheduledExecutorService;
    private HashMap<String, Future > map  ;

    public WkHeartBeatTool() {
    	initTool();
    }


    /**
     * 获取 任务总数
     */
    public int getTaskNum(){
    	return map==null? 0 : map.size() ;
    }


    /**
     * 初始化
     */
    private void initTool() {
        /// 线程池大小  5
    	mScheduledExecutorService = Executors.newScheduledThreadPool(5);
    	map = new HashMap<String, Future>() ;

    }

    /**
     *  开始一个心跳 任务. TimeUnit.MILLISECONDS ,
     */
    public void startTheBeatAction(HeartBeatTask task , int period){

    	if(map.containsKey(task.getTaskName())){
    		System.out.println("心跳正在进行，无需重复添加");
    		return ;
    	}
    	Future  future = mScheduledExecutorService.scheduleAtFixedRate( task , 0, period, TimeUnit.MILLISECONDS);
    	map.put(task.getTaskName() , future) ;

    }


    /**
     * 关闭指定的心跳任务
     */
    public void shutDownTheBeatAction(HeartBeatTask task ){
    	Future future = map.get(task.getTaskName()) ;
    	// 传入true会中断线程停止任务
    	if(future!=null){
    		future.cancel(true) ;
        	map.remove(task.getTaskName()) ;
    	}else{
    		System.out.println("你指定的这个心跳任务已经不存在，无需关闭");
    	}
    }


    /**
     * 延时任务 , TimeUnit.MILLISECONDS
     */
    public void startDelayedAction( HeartBeatTask task , int delayTime){
        mScheduledExecutorService.schedule( task, delayTime ,TimeUnit.MILLISECONDS );
    }


    /**
     * 销毁所有变量
     */
    public void shutDownAll() {

        if (mScheduledExecutorService != null) {
            // 强制关闭
            mScheduledExecutorService.shutdownNow();
            mScheduledExecutorService = null;
        }

        map.clear();
        map=null ;
    }

}
```
<br>

## 测试
```java
WkHeartBeatTool heartBeatTool = new WkHeartBeatTool() ;
HeartBeatTask task1 = new HeartBeatTask() {
  public void run() { ...}
};
// 开始心跳
heartBeatTool.startTheBeatAction(task1, 1000) ;
// 停止心跳
heartBeatTool.shutDownTheBeatAction(task1) ;
// 发送延时任务
heartBeatTool.startDelayedAction(task1, 5 * 1000) ;
// 获取 心跳任务总数
int sum = heartBeatTool.getTaskNum() ;
// 关闭所有任务 并销毁工具
heartBeatTool.shutDownAll() ;
```
