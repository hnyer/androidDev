# 心跳机制
心跳包机制、延迟发送任务
```java
public abstract class HeartBeatTask implements Runnable {
	private String taskName  ;
	public HeartBeatTask( ){
		taskName = "beatTask_"+System.nanoTime() ;
	}

	public String getTaskName() {
		return taskName;
	}
}
```

 

```java
 public class WkHeartBeatTool {
    private ScheduledExecutorService mScheduledExecutorService;
    private HashMap<String, Future > map  ;

    public WkHeartBeatTool() {
    	initTool();
    }

    
    public int getTaskNum(){
    	return map==null? 0 : map.size() ;
    }

    private void initTool() {
    	mScheduledExecutorService = Executors.newScheduledThreadPool(5);// 线程池大小  5
    	map = new HashMap<String, Future>() ;
    }

    public void startTheBeatAction(HeartBeatTask task , int period){
    	if(map.containsKey(task.getTaskName())){
    		System.out.println("心跳正在进行，无需重复添加");
    		return ;
    	}
    	Future  future = mScheduledExecutorService.scheduleAtFixedRate( task , 0, period, TimeUnit.MILLISECONDS);
    	map.put(task.getTaskName() , future) ;
    }

    public void shutDownTheBeatAction(HeartBeatTask task ){
    	Future future = map.get(task.getTaskName()) ;
    	if(future!=null){
    		future.cancel(true) ; 
        	map.remove(task.getTaskName()) ;
    	}else{
    		System.out.println("你指定的这个心跳任务已经不存在，无需关闭");
    	}
    }
   
    public void startDelayedAction( HeartBeatTask task , int delayTime){
        mScheduledExecutorService.schedule( task, delayTime ,TimeUnit.MILLISECONDS );
    }

    public void shutDownAll() {
        if (mScheduledExecutorService != null) {
            mScheduledExecutorService.shutdownNow();  // 强制关闭
            mScheduledExecutorService = null;
        }

        map.clear();
        map=null ;
    }

}
```

 
```java
WkHeartBeatTool heartBeatTool = new WkHeartBeatTool() ;
HeartBeatTask task1 = new HeartBeatTask() {
  public void run() { ...}
};

heartBeatTool.startTheBeatAction(task1, 1000) ;// 开始心跳
heartBeatTool.shutDownTheBeatAction(task1) ;// 停止心跳
heartBeatTool.startDelayedAction(task1, 5 * 1000) ;// 发送延时任务
int sum = heartBeatTool.getTaskNum() ;// 获取 心跳任务总数
heartBeatTool.shutDownAll() ;// 关闭所有任务 并销毁工具
```
